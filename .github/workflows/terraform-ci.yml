name: Terraform CI

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project to validate'
        required: true
        type: choice
        options:
          - project-simple-ipaas
          - project-demo-ipaas-by-ai
      environment:
        description: 'Environment to validate'
        required: true
        type: choice
        options:
          - dev
          - prd

jobs:
  terraform:
    name: Terraform CI - ${{ github.event_name == 'workflow_dispatch' && format('{0}/{1}', github.event.inputs.project_name, github.event.inputs.environment) || 'PR Validation' }}
    runs-on: ubuntu-latest

    env:
      # For PR events, default to project-demo-ipaas-by-ai/dev for validation
      PROJECT_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.project_name || 'project-demo-ipaas-by-ai' }}
      ENVIRONMENT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}

    defaults:
      run:
        working-directory: ${{ env.PROJECT_NAME }}/env/${{ env.ENVIRONMENT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Project Directory
        run: |
          if [ ! -d "$GITHUB_WORKSPACE/${{ env.PROJECT_NAME }}/env/${{ env.ENVIRONMENT }}" ]; then
            echo "::error::Project directory ${{ env.PROJECT_NAME }}/env/${{ env.ENVIRONMENT }} does not exist"
            exit 1
          fi
          echo "âœ… Project directory validated: ${{ env.PROJECT_NAME }}/env/${{ env.ENVIRONMENT }}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend-config=backend.tfvars

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -var-file=${{ env.ENVIRONMENT }}.tfvars -out=plan.tfplan

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}
          path: ${{ env.PROJECT_NAME }}/env/${{ env.ENVIRONMENT }}/plan.tfplan
          retention-days: 5
